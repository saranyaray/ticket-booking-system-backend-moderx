name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ticketdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Lint code (eslint - optional, add if eslint is set up)
        run: |
          if [ -f ".eslintrc.json" ]; then npm run lint; else echo "No eslint config found, skipping"; fi

      - name: Run database migrations
        env:
          PGHOST: localhost
          PGUSER: postgres
          PGPASSWORD: postgres
          PGDATABASE: ticketdb
          PGPORT: 5432
        run: |
          psql -h localhost -U postgres -d ticketdb -f sql/schema.sql
          psql -h localhost -U postgres -d ticketdb -f sql/feature_flags.sql

      - name: Run unit tests (if tests exist)
        run: |
          if [ -d "tests" ] || [ -d "__tests__" ]; then npm test; else echo "No tests found, skipping"; fi

      - name: Run concurrency test
        env:
          TARGET_URL: http://localhost:3000
          PGHOST: localhost
          PGUSER: postgres
          PGPASSWORD: postgres
          PGDATABASE: ticketdb
          PGPORT: 5432
          CONCURRENCY: 50
          REQUESTS: 200
          SEATS_PER_REQUEST: 1
        run: |
          npm start > /tmp/server.log 2>&1 &
          sleep 3
          npm run test:concurrency
          kill %1 2>/dev/null || true

  build-and-push-docker:
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          tags: ticket-booking-backend:${{ github.sha }}
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Log in to Docker Registry (if needed)
        # Uncomment to push to Docker Hub or private registry
        # uses: docker/login-action@v2
        # with:
        #   username: ${{ secrets.DOCKER_USERNAME }}
        #   password: ${{ secrets.DOCKER_PASSWORD }}
        run: echo "Docker build successful"

      # Uncomment to push to registry
      # - name: Push Docker image
      #   uses: docker/build-push-action@v4
      #   with:
      #     context: .
      #     tags: docker.io/your-org/ticket-booking-backend:latest,docker.io/your-org/ticket-booking-backend:${{ github.sha }}
      #     push: true

  deploy-staging:
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v3

      - name: Deploy to staging
        run: |
          echo "Deploy to staging environment"
          # Example: deploy via SSH, kubectl, docker-compose, or cloud CLI
          # ssh user@staging-server "cd /app && git pull && docker-compose up -d"
          # or: kubectl apply -f k8s/staging-deployment.yaml

  deploy-production:
    runs-on: ubuntu-latest
    needs: build-and-push-docker
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      - name: Deploy to production
        run: |
          echo "Deploy to production environment"
          # Example: kubectl apply -f k8s/prod-deployment.yaml
          # or: terraform apply -auto-approve
          # or: serverless deploy

  notify:
    runs-on: ubuntu-latest
    needs: [ lint-and-test ]
    if: always()
    steps:
      - name: Notify on failure
        if: failure()
        run: |
          echo "Pipeline failed. Check logs."
          # Add Slack notification, email, etc.
